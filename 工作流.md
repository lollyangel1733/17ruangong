**总体目标**

- 构建“传统预处理 + 深度学习检测/分割”的稳健管线，降低光照/反射与背景干扰。
- 提升 Precision/Recall/mAP 指标，并提供可复现实验与工程化落地。

**阶段工作流**

- 阶段 0：现状梳理与指标基线

  - 目标与解释：统一现有数据集划分（train/valid/test）、统计类别分布与质检问题，固定当前评估脚本与指标输出作为对照基线，确保后续改进有明确对比。
  - 产出：一份数据画像报告、当前模型在 test 集的基线指标（Precision/Recall/mAP@0.50/mAP@0.50:0.95）。
- 阶段 1：预处理原型与数据清洗

  - 目标与解释：针对“光线与反射”和“背景干扰”快速试制若干传统图像处理模块，选出对识别最友好的组合。
  - 行动要点：灰度/颜色空间转换（HSV/Lab）、照明归一化（Retinex/白平衡/CLAHE）、去反射（高亮掩膜+局部降光+轻量修复）、去噪（Bilateral/Non-local Means）、背景剥离（颜色-纹理分割+形态学清理）。
  - 产出：一个可复用的预处理函数库（含参数配置），对代表性样本的前后对比集。
- 阶段 2：标注方案升级（支持不规则形状）

  - 目标与解释：锈蚀形态不规则，矩形框难以精确计量面积；升级为多边形/掩膜标注，支持分割学习或检测+掩膜估计。
  - 行动要点：选用标注工具（如 Labelme/CVAT/Roboflow），制定标注规范（类别、掩膜质量、遮挡与反射场景），抽样复核确保一致性。
  - 产出：一批经过预处理后的掩膜标注数据，标注指南与质检流程。
- 阶段 3：混合管线集成与端到端训练

  - 目标与解释：将阶段 1 的预处理作为训练/推理的前置步骤，试验两条主线：检测（YOLO）与分割（YOLO-seg/其他轻量分割）。
  - 行动要点：构建数据加载器融合预处理；配置训练超参（图像尺寸、增强策略、学习率调度）；分别训练检测与分割模型，记录同一 test 集评估。
  - 产出：两条模型训练产物（权重与评估报告），以及端到端推理脚本。
- 阶段 4：评估与对比实验

  - 目标与解释：以固定 test 集进行 A/B 对比，量化预处理与模型路线的贡献。
  - 行动要点：统一评估指标（Precision/Recall/mAP50/mAP50-95、锈蚀面积比例误差、置信度分布），统计不同场景（强反光/复杂背景）子集表现。
  - 产出：对比表与可视化曲线（PR/F1/混淆矩阵），结论与改进建议。
- 阶段 5：迭代优化与策略扩展

  - 目标与解释：针对劣势场景进行针对性迭代，优化预处理与模型。
  - 行动要点：调整预处理参数（去反射阈值、CLAHE力度等）、增强策略（光照/反射增强、颜色抖动）、损失函数与后处理（置信度阈值/NMS/分割后面积计算），必要时引入多模型集成（如先分割后检测或双分支）。
  - 产出：迭代实验记录，达到既定指标提升（例如 Recall ≥ 0.75、mAP50 ≥ 0.80）。
- 阶段 6：工程落地与前后端联调

  - 目标与解释：将管线集成到现有 Flask 前端，提供可选“预处理开关/参数面板”，并按模型输出分目录保存。
  - 行动要点：后端新增预处理选项与参数接口、前端交互与进度展示、结果落盘（原图/预处理图/标注图/CSV 指标），记录模型与参数。
  - 产出：稳定的在线演示与本地部署指南，自动化日志与结果归档。

**关键技术细节**

- 去反射与照明归一化策略
  - 使用颜色空间 HSV/Lab；依据亮度通道阈值提取高亮反射掩膜，结合饱和度约束减少误提。
  - 应用 CLAHE/Retinex/灰度世界白平衡，缓解整体曝光与色偏；对高亮区域局部降光或轻量 inpainting。
- 去噪与背景剥离
  - 纹理/颜色联合分割（K-Means/SLIC 超像素）+形态学开闭运算，清理小噪点与背景花纹。
  - 针对金属面纹理，优先用双边滤波保持边缘，同时去除细粒噪声。
- 模型选择建议（检测 vs 分割）
  - 若面积统计与形状精准性要求高，优先分割（YOLO-seg/轻量分割网络），直接由掩膜计算面积比例与置信度加权。
  - 若仅需定位与数量，检测（YOLO）即可；面积可用掩膜近似或“颜色-纹理掩膜 ∩ 检测框”估计。

**验收标准**

- 指标提升：相对基线，Precision/Recall/mAP 有统计显著提升；锈蚀面积估计误差下降。
- 稳定性：在强反光与复杂背景子集上性能不过度退化，结果一致性高。
- 工程化：预处理参数可配置、推理速度满足使用场景，结果自动落盘并带模型与参数追踪。

**风险与备选方案**

- 去反射效果不佳：引入更强的光照归一化（多尺度 Retinex）、或在训练中加入“反射增强”做域鲁棒。
- 背景剥离困难：改用分割模型主导，检测作为辅助手段；或用弱监督方法提升掩膜质量。
- 标注成本高：先以关键场景进行掩膜精标，其他样本用半自动掩膜（预处理初掩膜+人工修订）。

**下一步建议**

- 先执行阶段 0 与阶段 1，形成基线与预处理原型；并选 30–50 张代表性难例做小样本对比。
- 随后推进阶段 2 的掩膜标注升级，至少覆盖难例与部分常规场景。
- 并行搭建阶段 3 的两条训练路线，最快两周内完成第一轮 A/B 对比与结论沉淀。
- 确认目标指标阈值后，进入阶段 5 的定向迭代，最后在阶段 6 完成前后端集成与可视化落地。

需要我把阶段 1 的预处理原型先以独立脚本或后端可选开关的形式落地吗？如果你给我 3–5 张“强反光/复杂背景”的代表样本，我可以快速打通原型并展示前后对比效果。
